#!/bin/bash

# help
Help()
{
  echo "help"
  echo "  squash src_branch : squash-merge src_branch into current branch"
  echo "  squash -h : help"
}

while getopts ":h" option; do
   case $option in
      h) # display Help
         Help
         exit;;
     \?) # incorrect option
         echo "Error: Invalid option"
         exit;;
   esac
done

# check git repository exists
if [ -z "$(git rev-parse --is-inside-work-tree 2>/dev/null)" ]; then
  echo "Error: git repository not found in current directory"
  exit 1
fi

# read input
BRANCH=$1

if [ -z "$BRANCH" ]; then
  echo "Error: missing argument src_branch"
  exit 1
fi
if [ -z "$(git rev-parse --verify $SRC_BRANCH 2>/dev/null)" ]; then
  echo "Error: branch $SRC_BRANCH does not exist"
  exit 1
fi

# main program

CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

echo "Squashing branch $BRANCH into $CURRENT_BRANCH..."

git merge --squash $BRANCH
if [ $? -ne 0 ]; then
  echo "Error: aborting squash..."
  exit 1
fi

# append branch name to squash msg
cat > squash_msg.tmp <<- EOM
$src
$(cat .git/SQUASH_MSG)
EOM

git commit -F squash_msg.tmp
rm squash_msg.tmp
